---
- hosts: debian
  vars:
    setuptoolsDownloadURL: http://pypi.python.org/packages/source/s/setuptools/
    setuptoolsFile: setuptools-0.6c11.tar.gz
    setuptoolsExactFolder: setuptools-0.6c11
  user: root 

  tasks:
  # 增加网易开源镜像为更新源(ms有问题，只能在ubuntu下使用apt_repository?)
  # 要使用apt_repository模块先要安装python-software-properties
  #- name: ensure python-software-properties is installed
    #action: apt pkg=python-software-properties state=installed
    #tags: repository
  #- name: ensure netease mirror is in the sources list
    #action: apt_repository repo='$item'
    #with_items:
        #- deb http://mirrors.163.com/debian/ squeeze main non-free contrib
        #- deb http://mirrors.163.com/debian/ squeeze-proposed-updates main non-free contrib
        #- deb-src http://mirrors.163.com/debian/ squeeze main non-free contrib
        #- deb-src http://mirrors.163.com/debian/ squeeze-proposed-updates main non-free contrib
    #tags: repository

  # 确保git是最新版本
  - name: ensure git is at the latest version
    action: apt pkg=git state=latest
    tags: git

  # 安装easy_install
  - name: check whether easy_install is installed
    action: shell which easy_install
    register: easy_installResult
    tags: python
  - name: download easy_install
    action: command wget ${setuptoolsDownloadURL}${setuptoolsFile}
    only_if: "'${easy_installResult.stdout}'.find('bin/easy_install') == -1"
    tags: python
  - name: exact easy_install
    action: command tar -zxvf ${setuptoolsFile}
    only_if: "'${easy_installResult.stdout}'.find('bin/easy_install') == -1"
    tags: python
  - name: install easy_install
    action: command chdir=~/${setuptoolsExactFolder} python setup.py install
    only_if: "'${easy_installResult.stdout}'.find('bin/easy_install') == -1"
    tags: python
  - name: clean downloaded files
    action: command chdir=~ rm ${setuptoolsFile}
    only_if: "'${easy_installResult.stdout}'.find('bin/easy_install') == -1"
    tags: python

  # 安装pip
  - name: check whether pip installed
    action: shell which pip
    register: pipResult
    tags: python
  - name: install pip
    action: easy_install name=pip
    only_if: "'${pipResult.stdout}'.find('bin/pip') == -1"
    tags: python

  # 安装vitualenv和virtualenvwrapper
  - name: ensure virtualenv and virtualenvwrapper is installed
    action: easy_install name=$item
    with_items:
        - virtualenv
        - virtualenvwrapper
    tags: python
